# CUDA makefile, Taewoo Lee (twlee@speech.korea.ac.kr)
# 2015.6.17.

CUDA_INSTALL_PATH ?= /usr/local/cuda
CUDA_SAMPLE_PATH ?= /home/twlee/NVIDIA_CUDA-7.0_Samples
CXX := g++
LINK := nvcc
NVCC := nvcc 

# Includes
INCLUDES = -I$(CUDA_SAMPLE_PATH)/common/inc -I$(CUDA_INSTALL_PATH)/include -I.

# Common flags
COMMONFLAGS += $(INCLUDES) -w -DM=8 -DQ=3888 -DTD_GPU=0 -DTD_GPU_CC=0 -DTD_GPU_SRP=0 -DFD_GPU=1 -DFD_GPU_SRP=2
NVCCFLAGS += $(COMMONFLAGS)
CXXFLAGS += $(COMMONFLAGS) -I/usr/include -lm
CFLAGS += $(COMMONFLAGS)
LIB_CUDA := -L$(CUDA_INSTALL_PATH)/lib64 -lcudart -lcufft -lm

# CUDA code generation flags
SMS ?= 20 30 35 37 50 52
HIGHEST_SM := $(lastword $(sort $(SMS)))
ifneq ($(HIGHEST_SM),)
GENCODE_FLAGS += -gencode arch=compute_$(HIGHEST_SM),code=compute_$(HIGHEST_SM)
endif
NVCC_OPTS := $(GENCODE_FLAGS) -use_fast_math -O3 --compiler-options "-O3 --fast-math"
GCC_OPTS := -O3 --fast-math

OBJS = main.o
TARGET= exp
LINKLINE= $(LINK) $(LIB_CUDA) -o $(TARGET) $(OBJS) 

.SUFFIXES: .cpp .cu .o

$(TARGET): $(OBJS) Makefile
	$(LINKLINE)
main.o: main.cu main.h
	$(NVCC) $(NVCCFLAGS) $(NVCC_OPTS) -c $<

clean :
	rm -f ${OBJS} ${TARGET}
